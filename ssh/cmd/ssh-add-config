#!/usr/bin/env bash
set -e

if [ $# -lt 3 ] || [ $# -gt 4 ]; then
  echo "Usage: ssh-add-config <username> <hostname> <key_name> [host]"
  echo ""
  echo "  This command adds ssh remote configuration to ~/.ssh/config"
  echo "  If [host] is provided, it will be used as Host alias, otherwise hostname is used"
  exit 1
fi

USER_NAME="$1"
HOST_NAME="$2"
KEY_PATH="$HOME/.ssh/$3"
# If fourth argument is provided, use it as Host, otherwise use HOST_NAME
HOST="${4:-$HOST_NAME}"
SSH_CONFIG="$HOME/.ssh/config"

# configファイルが存在しない場合は作成
if [ ! -f "$SSH_CONFIG" ]; then
  mkdir -p "$HOME/.ssh"
  touch "$SSH_CONFIG"
  chmod 600 "$SSH_CONFIG"
fi

# バックアップ作成
cp "$SSH_CONFIG" "${SSH_CONFIG}.bak_$(date +%Y%m%d%H%M%S)" 2>/dev/null

# 指定ホストのセクション抽出用フラグ
in_host_section=0

# 新しい設定行を作成
new_host="Host $HOST"
new_hostname="  HostName $HOST_NAME"
new_user="  User $USER_NAME"
new_identity="  IdentityFile $KEY_PATH"

awk -v host="$HOST" -v host_line="$new_host" -v hostname_line="$new_hostname" -v user_line="$new_user" -v identity_line="$new_identity" '
  BEGIN { in_host=0; found_host=0 }
  /^Host[ \t]+/ {
    if (in_host == 1) { in_host=0 }
    if ($2 == host) { in_host=1; found_host=1; print; next }
  }
  {
    if (in_host == 1) {
      if ($1 == "HostName") {
        print hostname_line
      } else if ($1 == "User") {
        print user_line
      } else if ($1 == "IdentityFile")  {
        print identity_line
      }
      else {
        print
      }
    } else {
      print
    }
  }
  END {
    # host
    if (found_host == 0) {
      print host_line
      print hostname_line
      print user_line
      print identity_line
<<<<<<< Updated upstream
    }
=======
    } 
>>>>>>> Stashed changes
  }
' "$SSH_CONFIG" > "${SSH_CONFIG}.tmp"

mv "${SSH_CONFIG}.tmp" "$SSH_CONFIG"

echo "Updated SSH config for Host '$HOST' (HostName: '$HOST_NAME'). Backup saved as ${SSH_CONFIG}.bak_*"
